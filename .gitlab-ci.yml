image: node

before_script:
  - npm install
  - mkdir -p ~/.ssh
  - echo "$elantum_private_key" > ./key
  - chmod 700 ./key
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

cache:
  paths:
    - node_modules/

deploy backend dev:
  stage: deploy
  only:
  - /master/
  image: lorisleiva/laravel-docker:latest
  cache:
    paths:
    - vendor/
  script:
  - scp -P 2222 -i ./key -r backend/* gitlab@omp-frontend.elantum.com:/var/www/dev.berezadev.com
  - ssh -p 2222 -i ./key gitlab@omp-frontend.elantum.com "cd /var/www/dev.berezadev.com; composer install --prefer-dist --no-ansi --no-interaction --no-progress; php artisan migrate"
  - scp -P 2222 -i ./key -r src static webpack gitlab@omp-frontend.elantum.com:/var/www/dev.berezadev.com
#  - scp -P 2222 -i ./key -r static gitlab@omp-frontend.elantum.com:/var/www/dev.berezadev.com
#  - scp -P 2222 -i ./key -r webpack gitlab@omp-frontend.elantum.com:/var/www/dev.berezadev.com
  - scp -P 2222 -i ./key *.json .postcssrc gitlab@omp-frontend.elantum.com:/var/www/dev.berezadev.com
#  - scp -P 2222 -i ./key .postcssrc gitlab@omp-frontend.elantum.com:/var/www/dev.berezadev.com
  - ssh -p 2222 -i ./key gitlab@omp-frontend.elantum.com "cd /var/www/dev.berezadev.com; npm i; sudo -u www-data php artisan bereza:build"

deploy backend prod:
  stage: deploy
  only:
  - /prod/
  image: lorisleiva/laravel-docker:latest
  cache:
    paths:
    - vendor/
  script:
  - scp -P 2222 -i ./key -r backend/* gitlab@omp-frontend.elantum.com:/var/www/berezadev.com
  - ssh -p 2222 -i ./key gitlab@omp-frontend.elantum.com "cd /var/www/berezadev.com; composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-dev; php artisan migrate"

pages:
  only:
  - /master/
  artifacts:
    paths:
    - public
  script:
  - BUILD_OUTPUT=public npm run build

prod:
  only:
  - /prod/
  artifacts:
    paths:
    - public
  script:
  - BUILD=prod npm run build
  - scp -P 2222 -v -i ./key -r dist/* gitlab@omp-frontend.elantum.com:/var/www/berezadev.com/public
