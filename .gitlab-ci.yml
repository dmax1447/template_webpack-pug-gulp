image: node:11

before_script:
  - git submodule init
  - git submodule update
  - mkdir -p ~/.ssh
  - echo "$elantum_private_key" > ./key
  - chmod 700 ./key
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

cache:
  paths:
    - node_modules/

deploy backend dev:
  stage: deploy
  only:
  - /master/
  # image: lorisleiva/laravel-docker:latest
  cache:
    paths:
    - vendor/
  script:
  - scp -P 2222 -i ./key -r backend/* git@berezadev.com:/var/www/dev.berezadev.com
  - ssh -p 2222 -i ./key git@berezadev.com "cd /var/www/dev.berezadev.com; composer install --prefer-dist --no-ansi --no-interaction --no-progress; php artisan migrate; rm -rf src static webpack"
  - scp -P 2222 -i ./key -r src static webpack git@berezadev.com:/var/www/dev.berezadev.com
  - scp -P 2222 -i ./key *.json .postcssrc git@berezadev.com:/var/www/dev.berezadev.com
  - ssh -p 2222 -i ./key git@berezadev.com "cd /var/www/dev.berezadev.com; npm i; php artisan bereza:build --build"

deploy backend prod:
  stage: deploy
  only:
  - /prod/
  image: lorisleiva/laravel-docker:latest
  cache:
    paths:
    - vendor/
  script:
  - scp -P 2222 -i ./key -r backend/* git@berezadev.com:/var/www/berezadev.com
  - ssh -p 2222 -i ./key git@berezadev.com "cd /var/www/berezadev.com; composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-dev; php artisan migrate"

pages:
  only:
  - /master/
  artifacts:
    paths:
    - public
  script:
  - npm install
  - BUILD_OUTPUT=public npm run build

prod:
  only:
  - /prod/
  artifacts:
    paths:
    - public
  script:
  - npm install
  - BUILD=prod npm run build
  - scp -P 2222 -v -i ./key -r dist/* git@berezadev.com:/var/www/berezadev.com/public
  - scp -P 2222 -i ./key -r backend/* git@berezadev.com:/var/www/berezadev.com
  - ssh -p 2222 -i ./key git@berezadev.com "cd /var/www/berezadev.com; composer install --prefer-dist --no-ansi --no-interaction --no-progress; php artisan migrate; cp -R /var/www/dev.berezadev.com/public/uploads /var/www/berezadev.com/public"
